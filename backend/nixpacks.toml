# Nixpacks 設定 (Koyeb / Railway 等の buildpack デプロイ用)
#
# 注意: Koyeb では Docker モードを強く推奨します。
#   Dockerfile の方が確実にTeX Liveが構成されます。
#   Koyeb の設定で「Docker」を選択し、
#   Dockerfile path: backend/Dockerfile を指定してください。
#
# Buildpack モードの場合にのみ、この設定が使われます。

[phases.setup]
# TeX Live (LuaLaTeX 専用構成)
aptPkgs = [
    "texlive-latex-base",
    "texlive-latex-recommended",
    "texlive-latex-extra",
    "texlive-luatex",
    "texlive-pictures",
    "texlive-science",
    "texlive-fonts-recommended",
    "texlive-lang-japanese",
    "fonts-noto-cjk",
    "poppler-utils",
    "fontconfig",
]

[phases.build]
# TeX パッケージデータベースとフォントキャッシュを完全構築
cmds = [
    "mktexlsr || true",
    "texhash || true",
    "fc-cache -fv || true",
    "luaotfload-tool --update --force || true",
    "fmtutil-sys --byfmt lualatex || true",
    # 包括的スモークテスト: 全パッケージのキャッシュを構築
    "mkdir -p /tmp/texwarm && printf '\\\\documentclass{article}\\n\\\\usepackage[haranoaji]{luatexja-preset}\\n\\\\usepackage{amsmath,amssymb,amsthm,mathtools}\\n\\\\usepackage{xcolor}\\n\\\\usepackage{geometry}\\n\\\\usepackage{hyperref}\\n\\\\usepackage{graphicx}\\n\\\\usepackage{booktabs}\\n\\\\usepackage{enumitem}\\n\\\\usepackage{tcolorbox}\\n\\\\usepackage{tikz}\\n\\\\usepackage{circuitikz}\\n\\\\usepackage[version=4]{mhchem}\\n\\\\usepackage{pgfplots}\\n\\\\pgfplotsset{compat=1.18}\\n\\\\usepackage{fancyhdr}\\n\\\\usepackage{listings}\\n\\\\begin{document}\\nスモークテスト $E=mc^2$\\n\\\\end{document}\\n' > /tmp/texwarm/warm.tex && cd /tmp/texwarm && lualatex -interaction=nonstopmode warm.tex && lualatex -interaction=nonstopmode warm.tex && echo '=== lualatex cache warmed ===' && rm -rf /tmp/texwarm || echo '=== lualatex warmup failed (non-fatal) ==='",
    "luaotfload-tool --update || true",
    "echo '=== TeX verification ===' && which lualatex && kpsewhich luatexja.sty || echo 'Some TeX packages missing'",
]

[variables]
COMPILE_TIMEOUT_SECONDS = "120"
CJK_MAIN_FONT = "Noto Serif CJK JP"
CJK_SANS_FONT = "Noto Sans CJK JP"

[start]
cmd = "uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers 1"
