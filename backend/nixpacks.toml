# Nixpacks 設定 (Koyeb / Railway 等の buildpack デプロイ用)
#
# 注意: Koyeb では Docker モードを強く推奨します。
#   Dockerfile の方が確実にTeX Liveが構成されます。
#   Koyeb の設定で「Docker」を選択し、
#   Dockerfile path: backend/Dockerfile を指定してください。
#
# Buildpack モードの場合にのみ、この設定が使われます。

[phases.setup]
# TeX Live + CJK + LuaTeX サポート
aptPkgs = [
    "texlive-latex-base",
    "texlive-latex-recommended",
    "texlive-latex-extra",
    "texlive-luatex",
    "texlive-pictures",
    "texlive-science",
    "texlive-fonts-recommended",
    "texlive-lang-japanese",
    "texlive-lang-cjk",
    "texlive-lang-chinese",
    "texlive-xetex",
    "latex-cjk-common",
    "fonts-noto-cjk",
    "poppler-utils",
    "fontconfig",
]

[phases.build]
# TeX パッケージデータベースとフォントキャッシュを更新
# 各コマンドの失敗を許容 (|| true) して後続を実行
cmds = [
    "mktexlsr || true",
    "texhash || true",
    "fc-cache -fv || true",
    # lualatex フォントキャッシュを事前構築 (初回実行は 30-60 秒かかるが、ビルド時に済ませておけばランタイムは高速)
    "mkdir -p /tmp/texwarm && printf '\\\\documentclass{article}\\n\\\\usepackage{luatexja}\\n\\\\begin{document}\\nWarm up テスト\\n\\\\end{document}\\n' > /tmp/texwarm/warm.tex && cd /tmp/texwarm && lualatex -interaction=nonstopmode warm.tex && echo '=== lualatex cache warmed ===' && rm -rf /tmp/texwarm || echo '=== lualatex warmup failed (non-fatal) ==='",
    "echo '=== TeX verification ===' && which pdflatex && which lualatex && which xelatex && kpsewhich CJK.sty && kpsewhich luatexja.sty && kpsewhich xeCJK.sty || echo 'Some TeX packages missing'",
]

[variables]
COMPILE_MEM_LIMIT_MB = "512"
COMPILE_TOTAL_BUDGET_SECONDS = "42"
CJK_MAIN_FONT = "Noto Serif CJK JP"
CJK_SANS_FONT = "Noto Sans CJK JP"

[start]
cmd = "uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers 1"
